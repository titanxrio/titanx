ğŸ© Trusted Types Bypass & iframe Sandbox Escapes - Advanced XSS Evasionâ€‹

As browsers evolve, so do defenses. Trusted Types and iframe sandboxing are two powerful anti-XSS mechanisms â€” but under the right conditions, they can still be bypassed.

This bonus guide explores two advanced XSS evasion paths that few attackers exploit but every Red Teamer should understand.

ğŸ”“ Trusted Types Bypassâ€‹

Trusted Types is a browser-enforced defense that prevents DOM XSS by requiring special objects for sinks like `innerHTML`, `eval`, and `setTimeout`.

If enabled correctly, these prevent direct string-based injections:

document.body.innerHTML = "<script>alert(1)</script>"; // Blocked


But Trusted Types only protect specific sinks:â€‹

âœ… `innerHTML`, `outerHTML`, `insertAdjacentHTML`
âœ… `setTimeout`, `setInterval`
âœ… `eval`, `Function`, `script.src`, etc.

Still vulnerable:

âŒ `srcdoc`, `iframe.contentWindow.document.write()`
âŒ WebComponent APIs, custom render engines
âŒ If developers override policies or whitelist unsafe functions

Bypass via Legacy Functions:â€‹
If an app uses outdated or non-standard render logic:
JavaScript:
customRenderer.setContent(userInput); // No Trusted Types enforcement

Or if a library wraps `innerHTML` and disables Trusted Types:
JavaScript:
element.innerHTML = String(userInput); // Wrapper disables TT policy

Bypass Payload:â€‹
<svg onload=alert(document.domain)>

Mitigation Tips:â€‹

âœ… Enforce Trusted Types in strict mode:
Content-Security-Policy: require-trusted-types-for 'script';
âœ… Avoid 3rd-party libraries that bypass policies
âœ… Use DOMPurify in Trusted Types mode:
DOMPurify.sanitize(input, {RETURN_TRUSTED_TYPE: true})

ğŸšª iframe Sandbox Escapeâ€‹

Sandboxing iframes is meant to isolate risky content. But **misconfigured attributes** can leak access or allow script execution.

The Dangerous Combo:â€‹
HTML:
<iframe src="evil.html" sandbox="allow-scripts allow-same-origin"></iframe>

This breaks the origin isolation. Now the iframe can:

âœ… Read/write cookies
âœ… Access `localStorage`
âœ… Inject and run JavaScript

Real Exploit Example:â€‹
Attacker loads `evil.html` in sandboxed iframe with both `allow-scripts` and `allow-same-origin`. They then abuse the iframe to access or overwrite parent app data â€” or open a secondary vector like `postMessage`.

Mitigation Tips:â€‹

âœ… Never combine `allow-scripts` and `allow-same-origin`
âœ… Use `sandbox="allow-scripts"` or `sandbox="allow-same-origin"`, but not both
âœ… For untrusted content, use `sandbox=""` with no permissions
âœ… Combine with `CSP: frame-ancestors 'none'` to prevent embedding

ğŸ“Œ Final Thoughtsâ€‹

Trusted Types and iframe sandboxing are excellent defenses â€” but theyâ€™re not bulletproof. Weak implementations, legacy code, or misconfigured policies can open cracks for attackers to slip through.
